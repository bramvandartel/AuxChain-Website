const bytecode = '6080604052604051620014a9380380620014a98339818101604052810190620000299190620002f7565b6000831080620000395750600082105b80620000455750600086105b156200007d576040517fa9f8c41f00000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b3460078190555033600460006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff160217905550856006819055508460009081620000dd919062000631565b508360019081620000ef919062000631565b508242620000fe919062000747565b6003819055508160088190555080600290816200011c919062000631565b5050505050505062000782565b6000604051905090565b600080fd5b600080fd5b6000819050919050565b62000152816200013d565b81146200015e57600080fd5b50565b600081519050620001728162000147565b92915050565b600080fd5b600080fd5b6000601f19601f8301169050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b620001cd8262000182565b810181811067ffffffffffffffff82111715620001ef57620001ee62000193565b5b80604052505050565b60006200020462000129565b9050620002128282620001c2565b919050565b600067ffffffffffffffff82111562000235576200023462000193565b5b620002408262000182565b9050602081019050919050565b60005b838110156200026d57808201518184015260208101905062000250565b60008484015250505050565b6000620002906200028a8462000217565b620001f8565b905082815260208101848484011115620002af57620002ae6200017d565b5b620002bc8482856200024d565b509392505050565b600082601f830112620002dc57620002db62000178565b5b8151620002ee84826020860162000279565b91505092915050565b60008060008060008060c0878903121562000317576200031662000133565b5b60006200032789828a0162000161565b965050602087015167ffffffffffffffff8111156200034b576200034a62000138565b5b6200035989828a01620002c4565b955050604087015167ffffffffffffffff8111156200037d576200037c62000138565b5b6200038b89828a01620002c4565b94505060606200039e89828a0162000161565b9350506080620003b189828a0162000161565b92505060a087015167ffffffffffffffff811115620003d557620003d462000138565b5b620003e389828a01620002c4565b9150509295509295509295565b600081519050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052602260045260246000fd5b600060028204905060018216806200044357607f821691505b602082108103620004595762000458620003fb565b5b50919050565b60008190508160005260206000209050919050565b60006020601f8301049050919050565b600082821b905092915050565b600060088302620004c37fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff8262000484565b620004cf868362000484565b95508019841693508086168417925050509392505050565b6000819050919050565b6000620005126200050c62000506846200013d565b620004e7565b6200013d565b9050919050565b6000819050919050565b6200052e83620004f1565b620005466200053d8262000519565b84845462000491565b825550505050565b600090565b6200055d6200054e565b6200056a81848462000523565b505050565b5b8181101562000592576200058660008262000553565b60018101905062000570565b5050565b601f821115620005e157620005ab816200045f565b620005b68462000474565b81016020851015620005c6578190505b620005de620005d58562000474565b8301826200056f565b50505b505050565b600082821c905092915050565b60006200060660001984600802620005e6565b1980831691505092915050565b6000620006218383620005f3565b9150826002028217905092915050565b6200063c82620003f0565b67ffffffffffffffff81111562000658576200065762000193565b5b6200066482546200042a565b6200067182828562000596565b600060209050601f831160018114620006a9576000841562000694578287015190505b620006a0858262000613565b86555062000710565b601f198416620006b9866200045f565b60005b82811015620006e357848901518255600182019150602085019450602081019050620006bc565b86831015620007035784890151620006ff601f891682620005f3565b8355505b6001600288020188555050505b505050505050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601160045260246000fd5b600062000754826200013d565b915062000761836200013d565b92508282019050808211156200077c576200077b62000718565b5b92915050565b610d1780620007926000396000f3fe6080604052600436106100dd5760003560e01c80634e69d5601161007f57806391f901571161005957806391f9015714610233578063a05795871461025e578063aba8315014610289578063d57bde79146102b4576100dd565b80634e69d560146101c65780637284e416146101f157806373fac6f01461021c576100dd565b806335a063b4116100bb57806335a063b414610142578063378252f2146101595780634a79d50c146101705780634c1786ea1461019b576100dd565b806308551a53146100e25780631998aeef1461010d5780633197cbb614610117575b600080fd5b3480156100ee57600080fd5b506100f76102df565b6040516101049190610ae9565b60405180910390f35b610115610305565b005b34801561012357600080fd5b5061012c6104af565b6040516101399190610b1d565b60405180910390f35b34801561014e57600080fd5b506101576104b5565b005b34801561016557600080fd5b5061016e610619565b005b34801561017c57600080fd5b506101856106a9565b6040516101929190610bc8565b60405180910390f35b3480156101a757600080fd5b506101b0610737565b6040516101bd9190610b1d565b60405180910390f35b3480156101d257600080fd5b506101db61073d565b6040516101e89190610bc8565b60405180910390f35b3480156101fd57600080fd5b506102066107c2565b6040516102139190610bc8565b60405180910390f35b34801561022857600080fd5b50610231610850565b005b34801561023f57600080fd5b506102486109e8565b6040516102559190610ae9565b60405180910390f35b34801561026a57600080fd5b50610273610a0e565b6040516102809190610b1d565b60405180910390f35b34801561029557600080fd5b5061029e610a14565b6040516102ab9190610bc8565b60405180910390f35b3480156102c057600080fd5b506102c9610aa2565b6040516102d69190610b1d565b60405180910390f35b600460009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b600354421115610341576040517fbaf3f0f700000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b6008546006546103519190610c19565b3411610389576040517fc6388ef700000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b600073ffffffffffffffffffffffffffffffffffffffff16600560009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff161461045857600560009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff166108fc60085460065461042b9190610c19565b9081150290604051600060405180830381858888f19350505050158015610456573d6000803e3d6000fd5b505b33600560006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff160217905550600854346104a79190610c4d565b600681905550565b60035481565b600460009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff161461053c576040517f85d1f72600000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b600460009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff166108fc6007549081150290604051600060405180830381858888f193505050501580156105a6573d6000803e3d6000fd5b50600560009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff166108fc479081150290604051600060405180830381858888f1935050505015801561060f573d6000803e3d6000fd5b5042600381905550565b600460009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff16146106a0576040517f85d1f72600000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b42600381905550565b600080546106b690610cb0565b80601f01602080910402602001604051908101604052809291908181526020018280546106e290610cb0565b801561072f5780601f106107045761010080835404028352916020019161072f565b820191906000526020600020905b81548152906001019060200180831161071257829003601f168201915b505050505081565b60075481565b6060600354421015610786576040518060400160405280600481526020017f6f70656e0000000000000000000000000000000000000000000000000000000081525090506107bf565b6040518060400160405280600681526020017f636c6f736564000000000000000000000000000000000000000000000000000081525090505b90565b600180546107cf90610cb0565b80601f01602080910402602001604051908101604052809291908181526020018280546107fb90610cb0565b80156108485780601f1061081d57610100808354040283529160200191610848565b820191906000526020600020905b81548152906001019060200180831161082b57829003601f168201915b505050505081565b600560009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff16146108d7576040517f86efbb5500000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b6003544211610912576040517fbaf3f0f700000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b600560009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff166108fc6008549081150290604051600060405180830381858888f1935050505015801561097c573d6000803e3d6000fd5b50600460009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff166108fc479081150290604051600060405180830381858888f193505050501580156109e5573d6000803e3d6000fd5b50565b600560009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b60085481565b60028054610a2190610cb0565b80601f0160208091040260200160405190810160405280929190818152602001828054610a4d90610cb0565b8015610a9a5780601f10610a6f57610100808354040283529160200191610a9a565b820191906000526020600020905b815481529060010190602001808311610a7d57829003601f168201915b505050505081565b60065481565b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b6000610ad382610aa8565b9050919050565b610ae381610ac8565b82525050565b6000602082019050610afe6000830184610ada565b92915050565b6000819050919050565b610b1781610b04565b82525050565b6000602082019050610b326000830184610b0e565b92915050565b600081519050919050565b600082825260208201905092915050565b60005b83811015610b72578082015181840152602081019050610b57565b60008484015250505050565b6000601f19601f8301169050919050565b6000610b9a82610b38565b610ba48185610b43565b9350610bb4818560208601610b54565b610bbd81610b7e565b840191505092915050565b60006020820190508181036000830152610be28184610b8f565b905092915050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601160045260246000fd5b6000610c2482610b04565b9150610c2f83610b04565b9250828201905080821115610c4757610c46610bea565b5b92915050565b6000610c5882610b04565b9150610c6383610b04565b9250828203905081811115610c7b57610c7a610bea565b5b92915050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052602260045260246000fd5b60006002820490506001821680610cc857607f821691505b602082108103610cdb57610cda610c81565b5b5091905056fea26469706673582212206e042846798484a0d01bb36cef97d0b056cad54fe4dccda4c6f4d0e054a7f95964736f6c63430008120033';

function getTransactionReceipt(txHash) {
    return window.ethereum.request({
        method: 'eth_getTransactionReceipt', params:
            [txHash]
    });
}

async function listAuction(add_url, view_url) {
    $('#submit').replaceWith('<button id="submit" class="btn btn-primary" type="button" disabled><span class="spinner-grow spinner-grow-sm" role="status" aria-hidden="true"></span>Opening Metamask...</button>')
    const web3 = new Web3(window.ethereum);
    const startingPrice = $('#price').val();
    const title = $('#title').val();
    const description = $('#description').val();
    const duration = $('#duration').val() * 3600;
    const buyerDeposit = $('#buyerDeposit').val();
    const sellerDeposit = $('#sellerDeposit').val();
    const imageURL = $('#imageURL').val();
    console.log(sellerDeposit);
    console.log(web3.utils.toHex(sellerDeposit));
    const parameters = web3.eth.abi.encodeParameters(['uint256', 'string', 'string', 'uint256', 'uint256', 'string'], [startingPrice, title, description, duration, buyerDeposit, imageURL]);
    const accounts = await window.ethereum.request({method: 'eth_requestAccounts'});
    const account = accounts[0];
    $('#submit').replaceWith('<button id="submit" class="btn btn-primary" type="button" disabled><span class="spinner-grow spinner-grow-sm" role="status" aria-hidden="true"></span>Waiting for confirmation in Metamask...</button>')
    const createTransaction = window.ethereum.request({
        method: 'eth_sendTransaction', params:
            [{
                from: account,
                data: bytecode + parameters.replace('0x', ''),
                value: web3.utils.toHex(sellerDeposit),
            }]
    }).then(async (result) => {
        $('#submit').replaceWith('<button id="submit" class="btn btn-primary" type="button" disabled><span class="spinner-grow spinner-grow-sm" role="status" aria-hidden="true"></span>Waiting for transaction to be verified...</button>');
        const ITERATIONS = 30;

        i = 0;
        while (i < ITERATIONS) {
            i++;
            await new Promise(r => setTimeout(r, 2000));
            var receipt = await getTransactionReceipt(result);
            if (receipt !== null) {
                break;
            }
        }
        if (receipt === null) {
            $('#submit').replaceWith('<button id="submit" class="btn btn-danger" type="button" disabled>Error: Check your wallet</button>');
            return;
        }
        $('#submit').replaceWith('<button id="submit" class="btn btn-primary" type="button" disabled><span class="spinner-grow spinner-grow-sm" role="status" aria-hidden="true"></span>Loading confirmation..</button>');
        contractAddress = receipt.contractAddress;
        $.ajax({
            url: add_url.replace('0', contractAddress),
            type: 'GET',
            success: async function (result) {
                if (result === "ok") {
                    location.href = view_url.replace('0', contractAddress);
                } else {
                    $('#submit').replaceWith('<button id="submit" class="btn btn-danger" type="button" disabled>Error: Could not load auction. Check your wallet?</button>');
                }
            }
        });
    }).catch(async (error) => {
        $('#submit').replaceWith('<div id="submit"><button class="btn btn-danger" type="button" disabled>Error: Something went wrong in your Metamask.</button></div>');
        await new Promise(r => setTimeout(r, 5000));
        $('#submit').replaceWith('<button type="submit" class="btn btn-primary" id="submit">Try again</button>');
    });
}
