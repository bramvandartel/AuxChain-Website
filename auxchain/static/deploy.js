const bytecode = '0x608060405260405162001390380380620013908339818101604052810190620000299190620002e4565b6000821080620000395750600081105b80620000455750600085105b156200007d576040517fa9f8c41f00000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b3460068190555033600360006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff160217905550846005819055508360009081620000dd9190620005eb565b508260019081620000ef9190620005eb565b508142620000fe919062000701565b6002819055508060078190555050505050506200073c565b6000604051905090565b600080fd5b600080fd5b6000819050919050565b6200013f816200012a565b81146200014b57600080fd5b50565b6000815190506200015f8162000134565b92915050565b600080fd5b600080fd5b6000601f19601f8301169050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b620001ba826200016f565b810181811067ffffffffffffffff82111715620001dc57620001db62000180565b5b80604052505050565b6000620001f162000116565b9050620001ff8282620001af565b919050565b600067ffffffffffffffff82111562000222576200022162000180565b5b6200022d826200016f565b9050602081019050919050565b60005b838110156200025a5780820151818401526020810190506200023d565b60008484015250505050565b60006200027d620002778462000204565b620001e5565b9050828152602081018484840111156200029c576200029b6200016a565b5b620002a98482856200023a565b509392505050565b600082601f830112620002c957620002c862000165565b5b8151620002db84826020860162000266565b91505092915050565b600080600080600060a0868803121562000303576200030262000120565b5b600062000313888289016200014e565b955050602086015167ffffffffffffffff81111562000337576200033662000125565b5b6200034588828901620002b1565b945050604086015167ffffffffffffffff81111562000369576200036862000125565b5b6200037788828901620002b1565b93505060606200038a888289016200014e565b92505060806200039d888289016200014e565b9150509295509295909350565b600081519050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052602260045260246000fd5b60006002820490506001821680620003fd57607f821691505b602082108103620004135762000412620003b5565b5b50919050565b60008190508160005260206000209050919050565b60006020601f8301049050919050565b600082821b905092915050565b6000600883026200047d7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff826200043e565b6200048986836200043e565b95508019841693508086168417925050509392505050565b6000819050919050565b6000620004cc620004c6620004c0846200012a565b620004a1565b6200012a565b9050919050565b6000819050919050565b620004e883620004ab565b62000500620004f782620004d3565b8484546200044b565b825550505050565b600090565b6200051762000508565b62000524818484620004dd565b505050565b5b818110156200054c57620005406000826200050d565b6001810190506200052a565b5050565b601f8211156200059b57620005658162000419565b62000570846200042e565b8101602085101562000580578190505b620005986200058f856200042e565b83018262000529565b50505b505050565b600082821c905092915050565b6000620005c060001984600802620005a0565b1980831691505092915050565b6000620005db8383620005ad565b9150826002028217905092915050565b620005f682620003aa565b67ffffffffffffffff81111562000612576200061162000180565b5b6200061e8254620003e4565b6200062b82828562000550565b600060209050601f8311600181146200066357600084156200064e578287015190505b6200065a8582620005cd565b865550620006ca565b601f198416620006738662000419565b60005b828110156200069d5784890151825560018201915060208501945060208101905062000676565b86831015620006bd5784890151620006b9601f891682620005ad565b8355505b6001600288020188555050505b505050505050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601160045260246000fd5b60006200070e826200012a565b91506200071b836200012a565b9250828201905080821115620007365762000735620006d2565b5b92915050565b610c44806200074c6000396000f3fe6080604052600436106100c25760003560e01c80634c1786ea1161007f57806373fac6f01161005957806373fac6f01461020157806391f9015714610218578063a057958714610243578063d57bde791461026e576100c2565b80634c1786ea146101805780634e69d560146101ab5780637284e416146101d6576100c2565b806308551a53146100c75780631998aeef146100f25780633197cbb6146100fc57806335a063b414610127578063378252f21461013e5780634a79d50c14610155575b600080fd5b3480156100d357600080fd5b506100dc610299565b6040516100e99190610a16565b60405180910390f35b6100fa6102bf565b005b34801561010857600080fd5b50610111610469565b60405161011e9190610a4a565b60405180910390f35b34801561013357600080fd5b5061013c61046f565b005b34801561014a57600080fd5b506101536105d4565b005b34801561016157600080fd5b5061016a610665565b6040516101779190610af5565b60405180910390f35b34801561018c57600080fd5b506101956106f3565b6040516101a29190610a4a565b60405180910390f35b3480156101b757600080fd5b506101c06106f9565b6040516101cd9190610af5565b60405180910390f35b3480156101e257600080fd5b506101eb61077d565b6040516101f89190610af5565b60405180910390f35b34801561020d57600080fd5b5061021661080b565b005b34801561022457600080fd5b5061022d6109a3565b60405161023a9190610a16565b60405180910390f35b34801561024f57600080fd5b506102586109c9565b6040516102659190610a4a565b60405180910390f35b34801561027a57600080fd5b506102836109cf565b6040516102909190610a4a565b60405180910390f35b600360009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b6002544211156102fb576040517fbaf3f0f700000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b60075460055461030b9190610b46565b3411610343576040517fc6388ef700000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b600073ffffffffffffffffffffffffffffffffffffffff16600460009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff161461041257600460009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff166108fc6007546005546103e59190610b46565b9081150290604051600060405180830381858888f19350505050158015610410573d6000803e3d6000fd5b505b33600460006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff160217905550600754346104619190610b7a565b600581905550565b60025481565b600360009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff16146104f6576040517f85d1f72600000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b600360009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff166108fc6006549081150290604051600060405180830381858888f19350505050158015610560573d6000803e3d6000fd5b50600460009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff166108fc479081150290604051600060405180830381858888f193505050501580156105c9573d6000803e3d6000fd5b506000600281905550565b600360009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff161461065b576040517f85d1f72600000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b6000600281905550565b6000805461067290610bdd565b80601f016020809104026020016040519081016040528092919081815260200182805461069e90610bdd565b80156106eb5780601f106106c0576101008083540402835291602001916106eb565b820191906000526020600020905b8154815290600101906020018083116106ce57829003601f168201915b505050505081565b60065481565b60606002544211610741576040518060400160405280600481526020017f6f70656e00000000000000000000000000000000000000000000000000000000815250905061077a565b6040518060400160405280600681526020017f636c6f736564000000000000000000000000000000000000000000000000000081525090505b90565b6001805461078a90610bdd565b80601f01602080910402602001604051908101604052809291908181526020018280546107b690610bdd565b80156108035780601f106107d857610100808354040283529160200191610803565b820191906000526020600020905b8154815290600101906020018083116107e657829003601f168201915b505050505081565b600460009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff1614610892576040517f86efbb5500000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b60025442116108cd576040517fbaf3f0f700000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b600460009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff166108fc6007549081150290604051600060405180830381858888f19350505050158015610937573d6000803e3d6000fd5b50600360009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff166108fc479081150290604051600060405180830381858888f193505050501580156109a0573d6000803e3d6000fd5b50565b600460009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b60075481565b60055481565b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b6000610a00826109d5565b9050919050565b610a10816109f5565b82525050565b6000602082019050610a2b6000830184610a07565b92915050565b6000819050919050565b610a4481610a31565b82525050565b6000602082019050610a5f6000830184610a3b565b92915050565b600081519050919050565b600082825260208201905092915050565b60005b83811015610a9f578082015181840152602081019050610a84565b60008484015250505050565b6000601f19601f8301169050919050565b6000610ac782610a65565b610ad18185610a70565b9350610ae1818560208601610a81565b610aea81610aab565b840191505092915050565b60006020820190508181036000830152610b0f8184610abc565b905092915050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601160045260246000fd5b6000610b5182610a31565b9150610b5c83610a31565b9250828201905080821115610b7457610b73610b17565b5b92915050565b6000610b8582610a31565b9150610b9083610a31565b9250828203905081811115610ba857610ba7610b17565b5b92915050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052602260045260246000fd5b60006002820490506001821680610bf557607f821691505b602082108103610c0857610c07610bae565b5b5091905056fea26469706673582212208ecc81bd6149012c9ac315be8d7fbfc9824d6b6c2b9743abbf2a58bd6293c08d64736f6c63430008120033';

function getTransactionReceipt(txHash) {
    return window.ethereum.request({
        method: 'eth_getTransactionReceipt', params:
            [txHash]
    });
}

async function listAuction(add_url, view_url) {
    $('#submit').replaceWith('<button id="submit" class="btn btn-primary" type="button" disabled><span class="spinner-grow spinner-grow-sm" role="status" aria-hidden="true"></span>Opening Metamask...</button>')
    const web3 = new Web3(window.ethereum);
    const startingPrice = $('#price').val();
    const title = $('#title').val();
    const description = $('#description').val();
    const duration = $('#duration').val() * 3600;
    const buyerDeposit = $('#buyerDeposit').val();
    const sellerDeposit = $('#sellerDeposit').val();
    console.log(sellerDeposit);
    console.log(web3.utils.toHex(sellerDeposit));
    const parameters = web3.eth.abi.encodeParameters(['uint256', 'string', 'string', 'uint256', 'uint256'], [startingPrice, title, description, duration, buyerDeposit]);
    const accounts = await window.ethereum.request({method: 'eth_requestAccounts'});
    const account = accounts[0];
    $('#submit').replaceWith('<button id="submit" class="btn btn-primary" type="button" disabled><span class="spinner-grow spinner-grow-sm" role="status" aria-hidden="true"></span>Waiting for confirmation in Metamask...</button>')
    const createTransaction = window.ethereum.request({
        method: 'eth_sendTransaction', params:
            [{
                from: account,
                data: bytecode + parameters.replace('0x', ''),
                value: web3.utils.toHex(sellerDeposit),
            }]
    }).then(async (result) => {
        $('#submit').replaceWith('<button id="submit" class="btn btn-primary" type="button" disabled><span class="spinner-grow spinner-grow-sm" role="status" aria-hidden="true"></span>Waiting for transaction to be verified...</button>');
        const ITERATIONS = 30;

        i = 0;
        while (i < ITERATIONS) {
            i++;
            await new Promise(r => setTimeout(r, 2000));
            var receipt = await getTransactionReceipt(result);
            if (receipt !== null) {
                break;
            }
        }
        if (receipt === null) {
            $('#submit').replaceWith('<button id="submit" class="btn btn-danger" type="button" disabled>Error: Check your wallet</button>');
            return;
        }
        $('#submit').replaceWith('<button id="submit" class="btn btn-primary" type="button" disabled><span class="spinner-grow spinner-grow-sm" role="status" aria-hidden="true"></span>Loading confirmation..</button>');
        contractAddress = receipt.contractAddress;
        $.ajax({
            url: add_url.replace('0', contractAddress),
            type: 'GET',
            success: async function (result) {
                if (result === "ok") {
                    location.href = view_url.replace('0', contractAddress);
                } else {
                    $('#submit').replaceWith('<button id="submit" class="btn btn-danger" type="button" disabled>Error: Could not load auction. Check your wallet?</button>');
                }
            }
        });
    }).catch(async (error) => {
        $('#submit').replaceWith('<div id="submit"><button class="btn btn-danger" type="button" disabled>Error: Something went wrong in your Metamask.</button></div>');
        await new Promise(r => setTimeout(r, 5000));
        $('#submit').replaceWith('<button type="submit" class="btn btn-primary" id="submit">Try again</button>');
    });
}
